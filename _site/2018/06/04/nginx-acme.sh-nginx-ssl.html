<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="shortcut icon" href="/yqwoe.github.io/theme/img/favicon.ico" >
    <title>
        
            nginx支持ssl+acme.sh定时更新证书 &middot; 双城记
        
    </title>

    <script src="/yqwoe.github.io/theme/js/jquery-3.2.1.min.js"></script>
    <script src="/yqwoe.github.io/theme/js/popper.min.js"></script>
    <script src="/yqwoe.github.io/theme/js/bootstrap.min.js"></script>

    <link rel="stylesheet" href="/yqwoe.github.io/theme/css/bootstrap.css">
    <link rel="stylesheet" href="/yqwoe.github.io/theme/css/site.css">
    <link rel="stylesheet" href="/yqwoe.github.io/theme/css/syntax.css">
<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>nginx支持ssl+acme.sh定时更新证书 | 双城记</title>
<meta name="generator" content="Jekyll v3.8.2" />
<meta property="og:title" content="nginx支持ssl+acme.sh定时更新证书" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="不废话，直接进入实战。" />
<meta property="og:description" content="不废话，直接进入实战。" />
<link rel="canonical" href="http://localhost:4000/yqwoe.github.io/2018/06/04/nginx-acme.sh-nginx-ssl.html" />
<meta property="og:url" content="http://localhost:4000/yqwoe.github.io/2018/06/04/nginx-acme.sh-nginx-ssl.html" />
<meta property="og:site_name" content="双城记" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-06-04T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"不废话，直接进入实战。","@type":"BlogPosting","url":"http://localhost:4000/yqwoe.github.io/2018/06/04/nginx-acme.sh-nginx-ssl.html","headline":"nginx支持ssl+acme.sh定时更新证书","dateModified":"2018-06-04T00:00:00+08:00","datePublished":"2018-06-04T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/yqwoe.github.io/2018/06/04/nginx-acme.sh-nginx-ssl.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>


<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top justify-content-between">
    <a class="navbar-brand font-weight-bold" href="/yqwoe.github.io/index.html">双城记</a>
    <button class="navbar-toggler collapsed" type="button" data-toggle="collapse" data-target="#navbarContent" >
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarContent">
        <ul class="navbar-nav ml-auto">
        
            <li class="nav-item">
                <a href='/yqwoe.github.io/index.html'
                   class="nav-link">
                    主页
                </a>
            </li>
        
            <li class="nav-item">
                <a href='/yqwoe.github.io/about.html'
                   class="nav-link">
                    关于
                </a>
            </li>
        
            <li class="nav-item">
                <a href='/yqwoe.github.io/list/posts.html'
                   class="nav-link">
                    文章
                </a>
            </li>
        
        </ul>
    </div>
</nav>








<div class="container site-container" id="top">
    <div class="row">
        <div class="d-none d-lg-block col-lg-4 col-xl-4 side">
            








    <div class="sticky-top space-before">
    <div class="card bg-light mb-3">
        <div class="card-body">
            <div class="card-title">
                <h5>2018年06月04日</h5>
            </div>
            <div class="d-flex flex-wrap align-items-center">
                <span class="icon grey mr-2 mb-2">
                    <?xml version="1.0" encoding="utf-8"?>
<!-- Generator: Adobe Illustrator 18.1.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->

<svg version="1.1" id="Price_tag" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve">
<g>
	<path d="M19.388,0.405c-0.111-0.314-0.454-0.48-0.769-0.371c-0.315,0.109-0.481,0.455-0.372,0.77
		c0.929,2.67-0.915,4.664-2.321,5.732l-0.568-0.814c-0.191-0.273-0.618-0.5-0.95-0.504L11.22,5.232
		c-0.332-0.006-0.825,0.146-1.097,0.338l-9.394,6.587c-0.455,0.32-0.565,0.947-0.247,1.404l4.269,6.108
		c0.32,0.455,0.831,0.4,1.287,0.082l9.394-6.588c0.27-0.191,0.582-0.603,0.692-0.918l0.998-3.145
		c0.11-0.314,0.043-0.793-0.148-1.066l-0.346-0.496C18.516,6.091,20.476,3.534,19.388,0.405z M15.017,9.763
		c-0.727,0.51-1.731,0.332-2.24-0.396c-0.511-0.73-0.333-1.734,0.395-2.246C13.75,6.716,14.5,6.745,15.04,7.138
		c-0.272,0.164-0.459,0.26-0.494,0.275c-0.301,0.143-0.43,0.504-0.288,0.805c0.104,0.219,0.321,0.348,0.547,0.348
		c0.086,0,0.174-0.02,0.257-0.059c0.194-0.092,0.402-0.201,0.619-0.33C15.778,8.771,15.542,9.394,15.017,9.763z"/>
</g>
</svg>

                </span>
                
                    <a href="/yqwoe.github.io/list/posts.html#aliyun"
                       class="bg-white border rounded p-1 mr-2 mb-2 d-inline-block">
                        aliyun
                    </a>
                
                    <a href="/yqwoe.github.io/list/posts.html#阿里云"
                       class="bg-white border rounded p-1 mr-2 mb-2 d-inline-block">
                        阿里云
                    </a>
                
                    <a href="/yqwoe.github.io/list/posts.html#nginx"
                       class="bg-white border rounded p-1 mr-2 mb-2 d-inline-block">
                        nginx
                    </a>
                
                    <a href="/yqwoe.github.io/list/posts.html#ssl"
                       class="bg-white border rounded p-1 mr-2 mb-2 d-inline-block">
                        ssl
                    </a>
                
                    <a href="/yqwoe.github.io/list/posts.html#acme-sh"
                       class="bg-white border rounded p-1 mr-2 mb-2 d-inline-block">
                        acme.sh
                    </a>
                
                    <a href="/yqwoe.github.io/list/posts.html#ubuntu-14-04"
                       class="bg-white border rounded p-1 mr-2 mb-2 d-inline-block">
                        ubuntu 14.04
                    </a>
                
            </div>
            <div class="d-flex align-items-center mt-2">
                <span class="icon grey mr-1">
                    <?xml version="1.0" encoding="utf-8"?>
<!-- Generator: Adobe Illustrator 18.1.1, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->

<svg version="1.1" id="Arrow_left" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve">
<path d="M2.5,10L9,3.5V7h8v6H9v3.5L2.5,10z"/>
</svg>

                </span>
                <a href="/yqwoe.github.io/list/posts.html"> 回到文章 </a>
            </div>
        </div>
    </div>
</div>






        </div>
        <div class="col-md-12 col-lg-8 col-xl-8 pb-4 content">
            <link rel="stylesheet" href="/yqwoe.github.io/static/css/gitment.css">
<script src="/yqwoe.github.io/static/js/gitment.js"></script>
<h1 class="border border-top-0 border-right-0 border-left-0 mb-3 pb-2">nginx支持ssl+acme.sh定时更新证书</h1>

<div class="d-md-block d-lg-none">
    <div class="sticky-top space-before">
    <div class="card bg-light mb-3">
        <div class="card-body">
            <div class="card-title">
                <h5>2018年06月04日</h5>
            </div>
            <div class="d-flex flex-wrap align-items-center">
                <span class="icon grey mr-2 mb-2">
                    <?xml version="1.0" encoding="utf-8"?>
<!-- Generator: Adobe Illustrator 18.1.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->

<svg version="1.1" id="Price_tag" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve">
<g>
	<path d="M19.388,0.405c-0.111-0.314-0.454-0.48-0.769-0.371c-0.315,0.109-0.481,0.455-0.372,0.77
		c0.929,2.67-0.915,4.664-2.321,5.732l-0.568-0.814c-0.191-0.273-0.618-0.5-0.95-0.504L11.22,5.232
		c-0.332-0.006-0.825,0.146-1.097,0.338l-9.394,6.587c-0.455,0.32-0.565,0.947-0.247,1.404l4.269,6.108
		c0.32,0.455,0.831,0.4,1.287,0.082l9.394-6.588c0.27-0.191,0.582-0.603,0.692-0.918l0.998-3.145
		c0.11-0.314,0.043-0.793-0.148-1.066l-0.346-0.496C18.516,6.091,20.476,3.534,19.388,0.405z M15.017,9.763
		c-0.727,0.51-1.731,0.332-2.24-0.396c-0.511-0.73-0.333-1.734,0.395-2.246C13.75,6.716,14.5,6.745,15.04,7.138
		c-0.272,0.164-0.459,0.26-0.494,0.275c-0.301,0.143-0.43,0.504-0.288,0.805c0.104,0.219,0.321,0.348,0.547,0.348
		c0.086,0,0.174-0.02,0.257-0.059c0.194-0.092,0.402-0.201,0.619-0.33C15.778,8.771,15.542,9.394,15.017,9.763z"/>
</g>
</svg>

                </span>
                
                    <a href="/yqwoe.github.io/list/posts.html#aliyun"
                       class="bg-white border rounded p-1 mr-2 mb-2 d-inline-block">
                        aliyun
                    </a>
                
                    <a href="/yqwoe.github.io/list/posts.html#阿里云"
                       class="bg-white border rounded p-1 mr-2 mb-2 d-inline-block">
                        阿里云
                    </a>
                
                    <a href="/yqwoe.github.io/list/posts.html#nginx"
                       class="bg-white border rounded p-1 mr-2 mb-2 d-inline-block">
                        nginx
                    </a>
                
                    <a href="/yqwoe.github.io/list/posts.html#ssl"
                       class="bg-white border rounded p-1 mr-2 mb-2 d-inline-block">
                        ssl
                    </a>
                
                    <a href="/yqwoe.github.io/list/posts.html#acme-sh"
                       class="bg-white border rounded p-1 mr-2 mb-2 d-inline-block">
                        acme.sh
                    </a>
                
                    <a href="/yqwoe.github.io/list/posts.html#ubuntu-14-04"
                       class="bg-white border rounded p-1 mr-2 mb-2 d-inline-block">
                        ubuntu 14.04
                    </a>
                
            </div>
            <div class="d-flex align-items-center mt-2">
                <span class="icon grey mr-1">
                    <?xml version="1.0" encoding="utf-8"?>
<!-- Generator: Adobe Illustrator 18.1.1, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->

<svg version="1.1" id="Arrow_left" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve">
<path d="M2.5,10L9,3.5V7h8v6H9v3.5L2.5,10z"/>
</svg>

                </span>
                <a href="/yqwoe.github.io/list/posts.html"> 回到文章 </a>
            </div>
        </div>
    </div>
</div>

</div>

<p>不废话，直接进入实战。
<!--more-->
1.安装nginx</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt update
apt install nginx
</code></pre></div></div>
<p>2.配置nginx</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/nginx/sites-enabled/default

server {
  listen 80;
  server_name example.com ;
  return 301 https://example.com$request_uri;
}

server {
  listen 443 ssl;

  server_name example.com;

  ssl on;
  ssl_certificate         /var/www/ssl/example.com.cer;
  ssl_certificate_key     /var/www/ssl/example.com.key;
  ssl_dhparam             /var/www/ssl/dhparam.pem;
  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
  ssl_prefer_server_ciphers on;
  ssl_ciphers EECDH+CHACHA20:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5; #加密算法(CloudFlare 推荐的加密套件组)
  ssl_session_timeout 5m; #客户端会话缓存时间
  ssl_session_cache builtin:1000 shared:SSL:10m; #SSL 会话缓存类型和大小

  root /var/www/example/current/public;
  access_log /var/www/example/current/log/nginx.access.log;
  error_log /var/www/example/current/log/nginx.error.log info;
  
  error_page 500 502 503 504 /500.html;
  client_max_body_size 10M;
  keepalive_timeout 10;
}

</code></pre></div></div>
<p>3.安装acme.sh</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl https://get.acme.sh | sh
source ~/.bashrc
备注:如果本地创建了.bash_profie建议把此命令加入
</code></pre></div></div>
<p>4.申请证书</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>acme.sh --issue -d example.com -w /var/www/example/current/public
备注: 命令中的目录一定是通过nginx 80端口能够访问到的位置。命令执行成功后证书会存放在 ~/.acme.sh/example.com/
</code></pre></div></div>
<p>5.设置证书，并重启nginx</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>acme.sh --installcert -d example.com \
               --keypath       /var/www/ssl/example.com.key  \
               --fullchainpath /var/www/ssl/example.com.cer \
               --reloadcmd     "nginx -s reload"
</code></pre></div></div>
<p>6.生成 dhparam.pem 文件</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl dhparam -out /var/www/ssl/dhparam.pem 2048
备注：注意观察的话，证书和dhparam.pem的目录和nginx中是保持一致的。
</code></pre></div></div>
<p>7.查看定时更换任务</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ crontab -l
0 0 * * * "/home/ubuntu/.acme.sh"/acme.sh --cron --home "/home/ubuntu/.acme.sh" &gt; /dev/null
</code></pre></div></div>
<p>8.验证acme.sh定时更换任务</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>acme.sh --cron -f
</code></pre></div></div>
<p>9.你可能遇到的问题</p>

<p><a href="https://ruby-china.org/topics/31983">使用 acme.sh 给 Nginx 安装 Let’ s Encrypt 提供的免费 SSL 证书</a></p>



<div id="container"></div>
<script>
var myTheme = {
  render(state, instance) {
    const container = document.createElement('div')
    container.lang = "zh-CN"
    container.className = 'gitment-container gitment-root-container'
    container.appendChild(instance.renderHeader(state, instance))
    container.appendChild(instance.renderEditor(state, instance))
    container.appendChild(instance.renderComments(state, instance))
    container.appendChild(instance.renderFooter(state, instance))
    return container
  },
}
console.log(location)

var paths = location.pathname.split('/')
console.log(paths)
console.log(decodeURI(paths[paths.length - 1 ]))
var gitment = new Gitment({
    id: decodeURI(paths[paths.length - 1 ]),
  owner: 'yqwoe',
  repo: 'yqwoe.github.io',
  oauth: {
    client_id: '38908a117aeb2426fddb',
    client_secret: 'fab30686c5598f5ba19e726492b27e33e40eceda',
  },
  theme: myTheme
})
gitment.render('container')
</script>
<style>
blockquote{
          font: 14px/22px normal helvetica, sans-serif;
          margin-top: 10px;
          margin-bottom: 10px;
          margin-left: 50px;
          padding-left: 15px;
          padding-top: 10px;
          padding-right: 10px;
          padding-bottom: 10px;
          border-left: 3px solid #ccc;
          background-color:none;
     }
</style>





        </div>
        <div class="col-md-12 d-lg-none bottom">
            

        </div>
    </div>
</div>

<script type="text/javascript">
/*!
 * IE10 viewport hack for Surface/desktop Windows 8 bug
 * Copyright 2014-2017 The Bootstrap Authors
 * Copyright 2014-2017 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 */

// See the Getting Started docs for more information:
// https://getbootstrap.com/getting-started/#support-ie10-width

(function () {
    'use strict'

    if (navigator.userAgent.match(/IEMobile\/10\.0/)) {
        var msViewportStyle = document.createElement('style')
        msViewportStyle.appendChild(
            document.createTextNode(
                '@-ms-viewport{width:auto!important}'
            )
        )
        document.head.appendChild(msViewportStyle)
    }
}())
</script>

</body>

</html>
