<!DOCTYPE html><html><head><meta charset="utf-8"><title>k8s 1.19.2 部署 traefik 2.2 | rm -rf /*</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico"><link rel="mask-icon" href="{{ url_for(theme.favicon.safari_pinned_tab) }}" color="{{ theme.android_chrome_color }}"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/highlight.css"><meta name="description" content="k8s 1.19.2部署 traefik 2.2"><meta property="og:type" content="article"><meta property="og:title" content="k8s 1.19.2 部署 traefik 2.2"><meta property="og:url" content="https://rm-rf.ink/*/3724466435.html"><meta property="og:site_name" content="rm -rf &#x2F;*"><meta property="og:description" content="k8s 1.19.2部署 traefik 2.2"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2020-11-13T03:05:00.000Z"><meta property="article:modified_time" content="2020-11-13T03:05:00.000Z"><meta property="article:author" content="Yq Woe"><meta property="article:tag" content="k8s"><meta property="article:tag" content="docker"><meta property="article:tag" content="容器技术"><meta property="article:tag" content="traefik2"><meta name="twitter:card" content="summary"><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="rm -rf /*" type="application/atom+xml"></head><body><div id="wrapper"><header id="header"><h1 id="title"><a href="/">rm -rf /*</a></h1><nav><a class="nav-link" href="/">首页</a> <span class="nav-spacer"></span> <a class="nav-link" href="/archives">归档</a> <span class="nav-spacer"></span> <a class="nav-link" href="/about">关于</a></nav></header><div id="content"><article id="post-2020-11-13- traefik2 部署" class="article article-type-post" itemprop="blogPost" itemscope><div class="article-inner"><header class="article-header"><h2 class="article-title" itemprop="headline name">k8s 1.19.2 部署 traefik 2.2</h2><div class="article-meta"><time class="article-date" datetime="2020-11-13T03:05:00.000Z" itemprop="datePublished">20/11/13 11:5:0 上午</time></div></header><div class="article-entry" itemprop="articleBody"><div id="toc" class="toc-article"><div class="toc-title">目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#一-traefik-简介"><span class="toc-text">一、Traefik 简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二-kubernetes-部署-traefik"><span class="toc-text">二、Kubernetes 部署 Traefik</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-ingress-routeyml"><span class="toc-text">1、ingress-route.yml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-创建-rbac-权限"><span class="toc-text">2、创建 RBAC 权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-创建-traefik-配置文件"><span class="toc-text">3、创建 Traefik 配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-节点设置-label-标签"><span class="toc-text">4、节点设置 Label 标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-kubernetes-部署-traefik"><span class="toc-text">5、Kubernetes 部署 Traefik</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三-traefik-路由规则配置"><span class="toc-text">三、Traefik 路由规则配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-配置-http-路由规则-traefik-dashboard-为例"><span class="toc-text">1、配置 HTTP 路由规则 （Traefik Dashboard 为例）</span></a></li></ol></li></ol></div><p><strong>系统环境：</strong></p><a id="more"></a><ul><li>Traefik 版本：v2.2</li><li>Kubernetes 版本：1.19.2</li></ul><p><strong>地址：</strong></p><ul><li>Traefik 2.2 官方文档：<a href="https://doc.traefik.io/traefik/v2.2/" target="_blank" rel="noopener">https://doc.traefik.io/traefik/v2.2/</a></li></ul><h2 id="一-traefik-简介"><a class="markdownIt-Anchor" href="#一-traefik-简介"></a> 一、Traefik 简介</h2><p>Traefik 最新推出了 v2.2 版本，这里将 Traefik 升级到最新版本，简单的介绍了下如何在 Kubernetes 环境下安装 Traefik v2.2</p><h2 id="二-kubernetes-部署-traefik"><a class="markdownIt-Anchor" href="#二-kubernetes-部署-traefik"></a> 二、Kubernetes 部署 Traefik</h2><blockquote><p>注意：这里 Traefik 是部署在 Kube-system Namespace 下，使用kustomize部署。</p></blockquote><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-rw-r--r--  1 yqwoe  staff   287 11 23 09:54 cluster-role-binding.yaml</span><br><span class="line">-rw-r--r--  1 yqwoe  staff   736 11 23 09:54 cluster-role.yaml</span><br><span class="line">-rw-r--r--  1 yqwoe  staff  2578 11 23 09:54 config.yaml</span><br><span class="line">-rw-r--r--  1 yqwoe  staff  1110 11 23 09:54 daemon-set.yaml</span><br><span class="line">-rw-r--r--  1 yqwoe  staff  2021 11 23 09:54 ingress-route.yml</span><br><span class="line">-rw-r--r--  1 yqwoe  staff   268 11 23 09:54 kustomization.yaml</span><br><span class="line">-rw-r--r--  1 yqwoe  staff    81 11 23 09:54 service-account.yaml</span><br><span class="line">-rw-r--r--  1 yqwoe  staff   220 11 23 09:54 service.yaml</span><br><span class="line">-rw-r--r--  1 yqwoe  staff   257 11 23 09:54 traefik-dashboard-route.yml</span><br></pre></td></tr></table></figure><p><strong>kustomization.yaml</strong></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kustomize.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Kustomization</span></span><br><span class="line"></span><br><span class="line"><span class="attr">resources:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">cluster-role.yaml</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">cluster-role-binding.yaml</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">service-account.yaml</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">config.yaml</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">daemon-set.yaml</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">service.yaml</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">ingress-route.yaml</span></span><br><span class="line"><span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"></span><br><span class="line"><span class="attr">commonLabels:</span></span><br><span class="line">  <span class="attr">app:</span> <span class="string">traefik</span></span><br></pre></td></tr></table></figure><h3 id="1-ingress-routeyml"><a class="markdownIt-Anchor" href="#1-ingress-routeyml"></a> 1、ingress-route.yml</h3><p>在 traefik v2.1 版本后，开始使用 CRD（Custom Resource Definition）来完成路由配置等，所以需要提前创建 CRD 资源。</p><p><strong>创建 ingress-route.yml 文件</strong></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingressroutes.traefik.containo.us</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">traefik.containo.us</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1alpha1</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">IngressRoute</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">ingressroutes</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">ingressroute</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">middlewares.traefik.containo.us</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">traefik.containo.us</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1alpha1</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Middleware</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">middlewares</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">middleware</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingressroutetcps.traefik.containo.us</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">traefik.containo.us</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1alpha1</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">IngressRouteTCP</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">ingressroutetcps</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">ingressroutetcp</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingressrouteudps.traefik.containo.us</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">traefik.containo.us</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1alpha1</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">IngressRouteUDP</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">ingressrouteudps</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">ingressrouteudp</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tlsoptions.traefik.containo.us</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">traefik.containo.us</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1alpha1</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">TLSOption</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">tlsoptions</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">tlsoption</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tlsstores.traefik.containo.us</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">traefik.containo.us</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1alpha1</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">TLSStore</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">tlsstores</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">tlsstore</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefikservices.traefik.containo.us</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">traefik.containo.us</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1alpha1</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">TraefikService</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">traefikservices</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">traefikservice</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br></pre></td></tr></table></figure><h3 id="2-创建-rbac-权限"><a class="markdownIt-Anchor" href="#2-创建-rbac-权限"></a> 2、创建 RBAC 权限</h3><p>Kubernetes 在 1.6 版本中引入了基于角色的访问控制（RBAC）策略，方便对 Kubernetes 资源和 API 进行细粒度控制。Traefik 需要一定的权限，所以这里提前创建好 Traefik ServiceAccount 并分配一定的权限。</p><p><strong>创建 service-account.yaml 文件</strong></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-ingress-controller</span></span><br></pre></td></tr></table></figure><p><strong>创建cluster-role.yaml</strong></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">""</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">secrets</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingresses/status</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">traefik.containo.us</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">middlewares</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingressroutes</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">traefikservices</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingressroutetcps</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingressrouteudps</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">tlsoptions</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">tlsstores</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br></pre></td></tr></table></figure><p><strong>创建cluster-role-binding.yaml</strong></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-ingress-controller</span></span><br></pre></td></tr></table></figure><h3 id="3-创建-traefik-配置文件"><a class="markdownIt-Anchor" href="#3-创建-traefik-配置文件"></a> 3、创建 Traefik 配置文件</h3><p>由于 Traefik 配置很多，通过 CLI 定义不是很方便，一般时候选择将其配置选项放到配置文件中，然后存入 ConfigMap，将其挂入 traefik 中。</p><p><strong>创建 config.yaml 文件</strong></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">traefik.yaml:</span> <span class="string">|-</span></span><br><span class="line">    <span class="attr">ping:</span> <span class="string">""</span>                    <span class="comment">## 启用 Ping</span></span><br><span class="line">    <span class="attr">serversTransport:</span></span><br><span class="line">      <span class="attr">insecureSkipVerify:</span> <span class="literal">true</span>  <span class="comment">## Traefik 忽略验证代理服务的 TLS 证书</span></span><br><span class="line">    <span class="attr">api:</span></span><br><span class="line">      <span class="attr">insecure:</span> <span class="literal">true</span>            <span class="comment">## 允许 HTTP 方式访问 API</span></span><br><span class="line">      <span class="attr">dashboard:</span> <span class="literal">true</span>           <span class="comment">## 启用 Dashboard</span></span><br><span class="line">      <span class="attr">debug:</span> <span class="literal">false</span>              <span class="comment">## 启用 Debug 调试模式</span></span><br><span class="line">    <span class="attr">metrics:</span></span><br><span class="line">      <span class="attr">prometheus:</span> <span class="string">""</span>            <span class="comment">## 配置 Prometheus 监控指标数据，并使用默认配置</span></span><br><span class="line">    <span class="attr">entryPoints:</span></span><br><span class="line">      <span class="attr">web:</span></span><br><span class="line">        <span class="attr">address:</span> <span class="string">":80"</span>          <span class="comment">## 配置 80 端口，并设置入口名称为 web</span></span><br><span class="line">      <span class="attr">websecure:</span></span><br><span class="line">        <span class="attr">address:</span> <span class="string">":443"</span>         <span class="comment">## 配置 443 端口，并设置入口名称为 websecure</span></span><br><span class="line">    <span class="attr">providers:</span></span><br><span class="line">      <span class="attr">kubernetesCRD:</span> <span class="string">""</span>         <span class="comment">## 启用 Kubernetes CRD 方式来配置路由规则</span></span><br><span class="line">      <span class="attr">kubernetesIngress:</span> <span class="string">""</span>     <span class="comment">## 启动 Kubernetes Ingress 方式来配置路由规则</span></span><br><span class="line">    <span class="attr">log:</span></span><br><span class="line">      <span class="attr">filePath:</span> <span class="string">""</span>              <span class="comment">## 设置调试日志文件存储路径，如果为空则输出到控制台</span></span><br><span class="line">      <span class="attr">level:</span> <span class="string">error</span>              <span class="comment">## 设置调试日志级别</span></span><br><span class="line">      <span class="attr">format:</span> <span class="string">json</span>              <span class="comment">## 设置调试日志格式</span></span><br><span class="line">    <span class="attr">accessLog:</span></span><br><span class="line">      <span class="attr">filePath:</span> <span class="string">""</span>              <span class="comment">## 设置访问日志文件存储路径，如果为空则输出到控制台</span></span><br><span class="line">      <span class="attr">format:</span> <span class="string">json</span>              <span class="comment">## 设置访问调试日志格式</span></span><br><span class="line">      <span class="attr">bufferingSize:</span> <span class="number">0</span>          <span class="comment">## 设置访问日志缓存行数</span></span><br><span class="line">      <span class="attr">filters:</span></span><br><span class="line">        <span class="comment">#statusCodes: ["200"]   ## 设置只保留指定状态码范围内的访问日志</span></span><br><span class="line">        <span class="attr">retryAttempts:</span> <span class="literal">true</span>     <span class="comment">## 设置代理访问重试失败时，保留访问日志</span></span><br><span class="line">        <span class="attr">minDuration:</span> <span class="number">20</span>         <span class="comment">## 设置保留请求时间超过指定持续时间的访问日志</span></span><br><span class="line">      <span class="attr">fields:</span>                   <span class="comment">## 设置访问日志中的字段是否保留（keep 保留、drop 不保留）</span></span><br><span class="line">        <span class="attr">defaultMode:</span> <span class="string">keep</span>       <span class="comment">## 设置默认保留访问日志字段</span></span><br><span class="line">        <span class="attr">names:</span>                  <span class="comment">## 针对访问日志特别字段特别配置保留模式</span></span><br><span class="line">          <span class="attr">ClientUsername:</span> <span class="string">drop</span></span><br><span class="line">        <span class="attr">headers:</span>                <span class="comment">## 设置 Header 中字段是否保留</span></span><br><span class="line">          <span class="attr">defaultMode:</span> <span class="string">keep</span>     <span class="comment">## 设置默认保留 Header 中字段</span></span><br><span class="line">          <span class="attr">names:</span>                <span class="comment">## 针对 Header 中特别字段特别配置保留模式</span></span><br><span class="line">            <span class="attr">User-Agent:</span> <span class="string">redact</span></span><br><span class="line">            <span class="attr">Authorization:</span> <span class="string">drop</span></span><br><span class="line">            <span class="attr">Content-Type:</span> <span class="string">keep</span></span><br><span class="line">    <span class="attr">certificatesresolvers:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="attr">acme:</span></span><br><span class="line">          <span class="attr">tlsChallenge:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">email:</span> <span class="string">"yqwoe@live.cn"</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">"acme.json"</span></span><br><span class="line">          <span class="attr">caserver:</span> <span class="string">"https://acme-v02.api.letsencrypt.org/directory"</span></span><br></pre></td></tr></table></figure><h3 id="4-节点设置-label-标签"><a class="markdownIt-Anchor" href="#4-节点设置-label-标签"></a> 4、节点设置 Label 标签</h3><p>由于是 Kubernetes DeamonSet 这种方式部署 Traefik，所以需要提前给节点设置 Label，这样当程序部署时 Pod 会自动调度到设置 Label 的节点上。</p><p><strong>节点设置 Label 标签</strong></p><ul><li>格式：kubectl label nodes [节点名] [key=value]</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl label nodes minikube IngressProxy=<span class="literal">true</span></span><br></pre></td></tr></table></figure><p><strong>查看节点是否设置 Label 成功</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get nodes --show-labels</span><br><span class="line"></span><br><span class="line">NAME       STATUS   ROLES    AGE   VERSION   LABELS</span><br><span class="line">minikube   Ready    master   3d    v1.19.2   IngressProxy=<span class="literal">true</span>,beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=minikube,kubernetes.io/os=linux,minikube.k8s.io/commit=b09ee50ec047410326a85435f4d99026f9c4f5c4,minikube.k8s.io/name=minikube,minikube.k8s.io/updated_at=2020_11_10T10_20_51_0700,minikube.k8s.io/version=v1.14.0,node-role.kubernetes.io/master=</span><br></pre></td></tr></table></figure><blockquote><p>如果想删除标签，可以使用 <code>kubectl label nodes minikube IngressProxy-</code> 命令</p></blockquote><h3 id="5-kubernetes-部署-traefik"><a class="markdownIt-Anchor" href="#5-kubernetes-部署-traefik"></a> 5、Kubernetes 部署 Traefik</h3><p>DaemonSet 方式部署，便于在多服务器间扩展，用 hostport 方式占用服务器 80、443 端口，方便流量进入。</p><p><strong>创建 traefik 部署文件 daemon-set.yaml</strong></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">60</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">traefik:v2.2</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">traefik-ingress-lb</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">hostPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">websecure</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">443</span></span><br><span class="line">          <span class="attr">hostPort:</span> <span class="number">443</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">admin</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">hostPort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">capabilities:</span></span><br><span class="line">            <span class="attr">drop:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">ALL</span></span><br><span class="line">            <span class="attr">add:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">NET_BIND_SERVICE</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">--configfile=/config/traefik.yaml</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">"/config"</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">"config"</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">traefik-config</span></span><br><span class="line">      <span class="attr">tolerations:</span>              <span class="comment">## 设置容忍所有污点，防止节点被设置污点</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">operator:</span> <span class="string">"Exists"</span></span><br><span class="line">      <span class="attr">nodeSelector:</span>             <span class="comment">## 设置node筛选器，在特定label的节点上启动</span></span><br><span class="line">        <span class="attr">IngressProxy:</span> <span class="string">"true"</span></span><br></pre></td></tr></table></figure><p><strong>创建Traefik Service service.yaml</strong></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">websecure</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">admin</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">traefik</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></table></figure><p>至此，traefik的配置基本完成。</p><p><strong>执行 kustomization.yaml</strong></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubectl apply -k . -n kube-system</span><br></pre></td></tr></table></figure><h2 id="三-traefik-路由规则配置"><a class="markdownIt-Anchor" href="#三-traefik-路由规则配置"></a> 三、Traefik 路由规则配置</h2><h3 id="1-配置-http-路由规则-traefik-dashboard-为例"><a class="markdownIt-Anchor" href="#1-配置-http-路由规则-traefik-dashboard-为例"></a> 1、配置 HTTP 路由规则 （Traefik Dashboard 为例）</h3><p>Traefik 应用已经部署完成，但是想让外部访问 Kubernetes 内部服务，还需要配置路由规则，这里开启了 Traefik Dashboard 配置，所以首先配置 Traefik Dashboard 看板的路由规则，使外部能够访问 Traefik Dashboard。</p><p><strong>创建 Traefik Dashboard 路由规则文件 traefik-dashboard-route.yaml</strong></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressRoute</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-dashboard-route</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">entryPoints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span> <span class="string">Host(`yqwoe.k8s.com`)</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Rule</span></span><br><span class="line">      <span class="attr">services:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">traefik</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure><p><strong>创建 Traefik Dashboard 路由规则对象</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f traefik-dashboard-route.yaml -n kube-system</span><br></pre></td></tr></table></figure><p><strong>接下来配置 Hosts</strong>，客户端想通过域名访问服务，必须要进行 DNS 解析，由于这里没有 DNS 服务器进行域名解析，所以修改 hosts 文件将 Traefik 指定节点的 IP 和自定义 host 绑定。打开电脑的 Hosts 配置文件，往其加入下面配置：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">192.168.10.2  yqwoe.k8s.com</span><br></pre></td></tr></table></figure><p><strong>配置完成后，打开浏览器输入地址：http://<code>yqwoe.k8s.com</code> 打开 Traefik Dashboard。</strong></p></div><div class="article-category"><a class="article-category-link" href="/categories/k8s/">k8s</a> <b>:分类</b><br><a class="article-tag-link" href="/tags/docker/" rel="tag">docker</a>, <a class="article-tag-link" href="/tags/k8s/" rel="tag">k8s</a>, <a class="article-tag-link" href="/tags/traefik2/" rel="tag">traefik2</a>, <a class="article-tag-link" href="/tags/%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/" rel="tag">容器技术</a> <b>:标签</b></div></div></article><nav id="article-nav" class="article-nav"><a href="/*/3382022550.html" id="article-nav-newer" class="article-nav-link-wrap newer"><strong class="article-nav-caption">上一篇</strong><div class="article-nav-title">基于k8s\traefik\springboot的微服务实践</div></a><a href="/*/848869235.html" id="article-nav-older" class="article-nav-link-wrap older"><strong class="article-nav-caption">下一篇</strong><div class="article-nav-title">一年要赚多少钱才能支撑一个三口之家？</div></a></nav></div></div><div id="settings-container"><div id="dark-mode"></div><div id="sans-font"></div></div><span class="post-count" style="position:fixed;bottom:10px;right:10px">21.1k</span><script type="text/javascript">console.log(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches);let d=document,r=d.documentElement.style,f=r.setProperty.bind(r),l=localStorage,s=l.getItem("s")||window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,n=l.getItem("n")||2,m=d.getElementById("dark-mode"),b=()=>{f("--bg-color","#fafafa"),f("--code-bg-color","#f4f4f4"),f("--text-color","#212121"),f("--secondary-color","#808080"),f("--tertiary-color","#b0b0b0"),f("--link-color","#b5c8cf"),f("--link-hover-color","#618794"),f("--link-bg-color","#dae4e7"),f("--selection-color","#dae4e7")},c=()=>{f("--bg-color","#212121"),f("--code-bg-color","#292929"),f("--text-color","#fff"),f("--secondary-color","#c0c0c0"),f("--tertiary-color","#6e6e6e"),f("--link-color","#4d6b75"),f("--link-hover-color","#96b1bb"),f("--link-bg-color","#5d828e"),f("--selection-color","#acc1c9")},o=d.getElementById("sans-font"),e=()=>{f("--body-stack",'"Lora", "Georgia", "Times New Roman", serif'),o.innerHTML="无衬"},g=()=>{f("--body-stack",'"Lato", "Lucida Grande", "Lucida Sans Unicode", "Lucida Sans", "Verdana", sans-serif'),o.innerHTML="衬线"};m.onclick=function(){2==s?(s=1,l.setItem("s",s),c()):(s=2,l.setItem("s",s),b())},o.onclick=function(){2==n?(n=1,l.setItem("n",n),g()):(n=2,l.setItem("n",n),e())},s?c():b(),n||(n=2,l.setItem("n",2)),1==n&&g()</script><script type="module">import mermaid from"https://cdn.jsdelivr.net/npm/mermaid@9.4.3/+esm";let theme=localStorage.getItem("s");mermaid.initialize({startOnLoad:!0,logLevel:"debug",theme:"2"===theme?"forest":"dark"});let mode=document.getElementById("dark-mode"),arrayGraphs=[],nodes=document.getElementsByClassName("mermaid");for(let e of nodes)console.log(e.innerHTML),arrayGraphs.push(e.innerHTML);mode.addEventListener("click",async()=>{theme=localStorage.getItem("s"),mermaid.initialize({startOnLoad:!0,logLevel:"debug",theme:"2"===theme?"forest":"dark"});for(let e=0;e<nodes.length;e++){let t=nodes[e];t.removeAttribute("data-processed"),t.setAttribute("id","mermaid-"+e),t.replaceChildren(),t.innerHTML=arrayGraphs[e],mermaid.init(void 0,t)}},!1)</script></body></html>